# 機能仕様書 - 国土地理院 地形図ビューア

## 1. 概要

本アプリケーションは、国土地理院の提供する地図を背景に、ユーザーが任意のPNG画像をオーバーレイ表示し、そのサイズと透過度をUIから調整できるWebアプリケーションである。また、ExcelファイルからGPSデータを読み込み、地図上にマーカーとして表示する機能も提供する。

## 2. 機能一覧

- **地図表示機能**
  - 特定の初期地点（箕面大滝）を中心とした国土地理院の地図を表示する。
  - 初期地点にマーカーを表示する。
  - 右下にスケールバーを表示する。
- **中心座標の表示と設定機能**
- **画像オーバーレイ機能**
  - ローカルからPNG画像を読み込む。
  - 読み込んだ画像を地図の中心に重ねて表示する。
  - 画像の表示倍率と透過度をUIから調整できる。
- **GPSデータ読み込み機能**
  - ローカルからExcel(.xlsx)ファイルを読み込む。
  - Excelファイルに含まれる複数の地点情報（名称、緯度、経度）をマーカーとして地図上に表示する。
  - 緯度・経度は度分秒形式の文字列から実数値に変換して処理する。
- **GeoJSONデータ読み込み機能**
  - ローカルからGeoJSON(.geojson, .json)ファイルを読み込む。
  - GeoJSONファイルに含まれる地理データ（ポイント、ライン、ポリゴン）を地図上に表示する。
  - ポリゴンは枠線のみ表示し、内部は塗りつぶさない。

## 3. 詳細仕様

### 3.1. 地図表示機能

#### 3.1.1. 初期表示

- **初期中心座標**: 箕面大滝 (緯度: 34.853667, 経度: 135.472041)
- **初期ズームレベル**: 15

#### 3.1.2. 地図タイル

- **使用タイル**: 国土地理院 標準地図 (`https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png`)
- **帰属表示**: 地図右下に「地理院タイル」のクレジットと、国土地理院のWebサイトへのリンクを表示する。

#### 3.1.3. スケールバー

- **位置**: 地図の右下
- **表示内容**: メートル系（キロメートル・メートル）のみ表示
- **サイズ**: 最大幅150px（約1.5倍のサイズ）

#### 3.1.4. マーカー

- アプリケーションの起動時に、初期中心座標（箕面大滝）にマーカーが設置される。
- このマーカーは、「中心座標」ボタンを使用して地図上をクリックすることで、任意の位置に再設置できる。
- マーカーの位置座標（緯度・経度）は、UI上の「北緯」「東経」テキストボックスに表示される。

### 3.2. 画像オーバーレイ機能

#### 3.2.1. UIコンポーネント

画面右上に以下の操作コントロールを配置する。

- **表示倍率コントロール**
  - `表示倍率` というラベルを持つ数値入力欄。
  - **初期値**: 0.3
  - **入力範囲**: 0.1以上
  - **機能**: 地図の表示領域の幅に対する画像の幅の比率を指定する。値が変更されると、即座に画像のサイズが更新される。

- **透過度コントロール**
  - `透過度(%)` というラベルを持つ数値入力欄。
  - **初期値**: 50
  - **入力範囲**: 0 から 100
  - **機能**: オーバーレイ画像の不透明度をパーセントで指定する（0%で完全透明、100%で完全不透明）。値が変更されると、即座に画像の透過度が更新される。

- **中心座標ボタン**
  - `[中心座標]` というラベルのボタン。
  - クリックすると「中心座標設定モード」になり、ボタンがアクティブ（押し込み）状態に変わる。
  - このモード中に地図上をクリックすると、その位置にマーカーが設置され、地図の中心が移動し、モードは自動的に解除される。

- **北緯・東経表示欄**
  - `北緯` と `東経` のラベルを持つ読み取り専用のテキストボックス。
  - 地図上のマーカーの緯度と経度を小数点以下6桁で表示する。
  - アプリケーション起動時、およびマーカーが更新されるたびに、表示値は自動的に更新される。

- **画像読込ボタン**
  - `[画像読込]` というラベルのボタン。
  - クリックすると、ファイル選択ダイアログが開く。
  - 選択可能なファイル形式はPNG画像 (`image/png`) のみ。

- **GPS値読込ボタン**
  - `[GPS値読込]` というラベルのボタン。
  - `[画像読込]` ボタンの下に配置する。
  - クリックすると、ファイル選択ダイアログが開く。
  - 選択可能なファイル形式はExcelファイル (`.xlsx`) のみ。

- **GeoJSON読込ボタン**
  - `[GeoJSON読込]` というラベルのボタン。
  - `[GPS値読込]` ボタンの下に配置する。
  - クリックすると、ファイル選択ダイアログが開く。
  - 選択可能なファイル形式はGeoJSONファイル (`.geojson`, `.json`) のみ。

#### 3.2.2. 画像読み込み

- ユーザーがファイル選択ダイアログでPNGファイルを選択すると、`FileReader` API を使用して画像を読み込む。
- 読み込みが完了すると、`Image` オブジェクトの `onload` イベントが発火し、画像表示処理 (`updateImageDisplay`) が実行される。
- 一度ファイルを選択した後でも、同じファイルを再度選択して読み込み直すことが可能。

#### 3.2.3. 画像表示

- 読み込まれた画像は、`L.imageOverlay` を使用して、現在の地図表示の中心に配置される。
- 画像のサイズは、「表示倍率」コントロールの値と地図の表示幅に基づいて計算される。
- 画像の縦横比は常に維持される。
- 既に別の画像が表示されている場合、古い画像は地図から削除され、新しい画像に置き換わる。

#### 3.2.4. 画像操作

- **UIによる操作**:
  - **サイズ変更**: 「表示倍率」コントロールの値を変更すると、画像のサイズが即座に更新される。
  - **透過度変更**: 「透過度」コントロールの値を変更すると、画像の透過度が即座に更新される。
- **マウス操作**:
  - マウスによる画像の直接的な移動、リサイズ、回転、変形はできない。
- **中心座標ボタン操作時の画像クリア**:
  - 「中心座標」ボタンをクリックした際、すでに画像が読み込まれて表示されている場合は、その画像オーバーレイを地図から削除し、クリアする。

#### 3.2.5. エラー処理

- **無効な画像**: 読み込んだファイルのサイズが0など、有効な画像として認識できない場合、「有効な画像ファイルではありません。別のファイルを選択してください。」というメッセージボックスを表示する。
- **読み込み失敗**: ファイルが破損しているなどの理由で画像の読み込みに失敗した場合、「画像の読み込みに失敗しました。ファイルが破損している可能性があります。」というメッセージボックスを表示する。

### 3.3. GPSデータ読み込み機能

#### 3.3.1. UIコンポーネント

- **GPS値読込ボタン**
  - `[GPS値読込]` というラベルのボタン。
  - クリックするとファイル選択ダイアログが開き、ユーザーはExcel(.xlsx)ファイルを選択できる。

#### 3.3.2. Excelファイル形式

- **フォーマット**: Excel(.xlsx)ファイルの最初のシートを使用
- **列の構成**:
  - C列: 地点名の前半部分
  - D列: 緯度（度分秒形式の文字列）
  - E列: 経度（度分秒形式の文字列）
  - G列: 地点名の後半部分
- **ヘッダー行**: 1行目はヘッダーとして扱い、2行目以降をデータとして処理
- **文字コード**: UTF-8

#### 3.3.3. 緯度・経度の度分秒変換仕様

**緯度（D列）:**
- 8文字未満の場合は右を0で埋めて8文字に調整
- 形式: 2桁度 + 2桁分 + 2桁秒整数 + 小数部
- 例: "34502066" → 34度50分20.66秒 → 34.839072度

**経度（E列）:**
- 9文字未満の場合は右を0で埋めて9文字に調整
- 形式: 3桁度 + 2桁分 + 2桁秒整数 + 小数部
- 例: "135274106" → 135度27分41.06秒 → 135.461406度

#### 3.3.4. データ読み込みとマーカー設置

- `FileReader` API とSheetJSライブラリを使用して、選択されたExcelファイルを読み込む。
- 読み込み完了後、各行のデータを処理し、地点情報（名称、緯度、経度）を取得する。
- 名称はC列とG列をスペース区切りで結合して生成する。
- 緯度・経度は度分秒形式の文字列から実数値に変換する。
- 各地点情報に基づいて `L.marker` を作成し、地図上に追加する。
- マーカーには、クリックするとその地点の「名称」がポップアップで表示されるように設定する。
- 新しいExcelファイルが読み込まれた場合、以前にExcelから読み込んで表示されていたマーカーはすべて削除してから、新しいマーカーを設置する。（※初期表示のマーカーや中心座標設定用のマーカーは対象外）

#### 3.3.5. データ検証

- **名称の検証**: C列とG列が両方とも空の場合、その行をスキップする。
- **緯度・経度の検証**: 
  - 緯度・経度が0以下の場合はスキップする。
  - 度分秒形式として正しく解析できない場合はスキップする。
- **デバッグ情報**: 1件目のデータについて、元の文字列と変換後の実数値をコンソールに出力する。

#### 3.3.6. エラー処理

- **フォーマットエラー**: Excelの行が8列未満の場合や、緯度・経度が度分秒形式として解釈できない場合は、その行をスキップし、処理を続行する。
- **読み込み失敗**: すべての行がエラーでマーカーを一つも設置できなかった場合、処理を継続するが、コンソールにエラー情報を出力する。

### 3.4. GeoJSONデータ読み込み機能

#### 3.4.1. UIコンポーネント

- **GeoJSON読込ボタン**
  - `[GeoJSON読込]` というラベルのボタン。
  - クリックするとファイル選択ダイアログが開き、ユーザーはGeoJSON(.geojson, .json)ファイルを選択できる。

#### 3.4.2. GeoJSONファイル形式

- **フォーマット**: GeoJSON標準仕様に準拠したJSONファイル
- **対応ジオメトリタイプ**:
  - Point: ポイントデータ
  - LineString: ライン（線）データ
  - Polygon: ポリゴン（面）データ
- **文字コード**: UTF-8

#### 3.4.3. データ読み込みと表示

- `FileReader` API を使用して、選択されたGeoJSONファイルをテキストとして読み込む。
- 読み込み完了後、JSONとしてパースし、`L.geoJSON()` を使用して地図上に表示する。
- 各ジオメトリタイプの表示仕様：
  - **Point**: 円形マーカー（半径6px、オレンジ色）で表示
  - **LineString**: オレンジ色の線（太さ2px）で表示
  - **Polygon**: オレンジ色の枠線（太さ2px）のみで表示、内部は塗りつぶさない
- 各要素の`properties.name`が存在する場合、クリック時にポップアップで表示する。

#### 3.4.4. エラー処理

- **JSONパースエラー**: GeoJSONファイルが有効なJSON形式でない場合、「GeoJSONファイルの読み込みに失敗しました。有効なGeoJSONファイルを選択してください。」というメッセージボックスを表示する。
- **読み込み失敗**: ファイルの読み込みに失敗した場合、コンソールにエラー情報を出力する。

## 4. 技術仕様

- **主要ライブラリ**:
  - Leaflet.js (v1.9.4): 地図表示と画像オーバーレイのコアライブラリ
  - SheetJS (v0.18.5): Excelファイル読み込み用ライブラリ
- **主要API**:
  - FileReader API: ローカルの画像ファイルやExcelファイルを読み込むために使用
- **スクリプト実行**:
  - HTML内の`<script>`タグに`defer`属性を付与し、HTMLの解析をブロックすることなくスクリプトを読み込む
  - `document.addEventListener('DOMContentLoaded', ...)` を利用して、DOMの準備が完了した後にアプリケーションを初期化する